---
title:  服务限流算法
date:   2021-09-09 16:22:07
categories: 
- 系统设计
---

限流也称流量控制，在服务限流中通常指代**限制到达系统的并发请求数**，避免服务因超过其处理能力阈值的流量而崩溃，**直接拒绝或延迟处理一部分流量**，从而保证系统的稳定性。
但这就影响了用户体验，所以限流是在服务稳定和用户体检之间的trade-off。

常见的限流算法主要有以下及几类：

#### 固定窗口计数限流法

窗口是指时间窗口，具体方案为对一段固定时间窗口内的请求进行计数，如果请求数超过了阈值，则舍弃该请求；如果没有达到设定的阈值，则接受该请求，且计数加1。下一个窗口时，重置计数器为0。

优点：实现简单，容易理解。
缺点：流量曲线可能不够平滑，有"突刺"现象。

如下图所示，假设当前限流为1s内限流5个：
* 在0.99~1.01s时，即窗口切换时，会出现1s两倍于阈值的请求，远超服务的负载能力，即**临界值问题**。
* 由于1.01s时，1~2秒内计数已达阈值，则1.01~2s内所有的请求均会被拒绝，服务不可用。

![固定窗口计数限流](https://raw.githubusercontent.com/GuanN1ng/diagrams/main/com.guann1n9.diagrams/distributed/fixedWindow.png)


#### 滑动窗口计数限流法

滑动窗口计数限流是为了解决固定窗口的临界值问题，保证在任意时间窗口内请求都不会超过设定的阈值。具体实现为将限流窗口细分为N个小窗口，分别记录每个小窗口内的请求数量，并根据
时间滑动，删除过期的小窗口。

![滑动窗口计数限流](https://raw.githubusercontent.com/GuanN1ng/diagrams/main/com.guann1n9.diagrams/distributed/slidingWindow.png)

但滑动窗口也无法解决短时间内流量峰值问题。

#### 漏桶算法

漏桶算法可以起到流量整型或速率限制的功能，漏桶意指一个请求容器，如FIFO的队列，且**以一个常量限制容器的出口流量速率**，当入口流量速率大于出口流量速率时，因为容器是有限的，
**当超出容器大小时，超出的流量会被丢弃**。

![漏桶算法](https://raw.githubusercontent.com/GuanN1ng/diagrams/main/com.guann1n9.diagrams/distributed/leakyBucket.png)

漏桶算法可以将请求平滑的放行，类似生产者-消费者模型，但消费端的能力被固定，限制了系统应对突发流量的能力。

#### 令牌桶算法

系统维护一个**固定容量的令牌桶**，并以一个固定速率向桶内添加令牌，桶内令牌达到最大后，后续生成的令牌被丢弃。请求到达后，需先**向令牌桶申请所需数量的令牌**，获取成功则可被处理，否则被丢弃。
当桶内有堆积的令牌时，允许立刻被全部取走，**令牌桶算法优化了漏桶算法面对突发流量时的低效**。

![令牌桶算法](https://raw.githubusercontent.com/GuanN1ng/diagrams/main/com.guann1n9.diagrams/distributed/tokenBucket.png)
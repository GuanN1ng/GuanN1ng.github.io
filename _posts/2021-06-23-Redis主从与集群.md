---
layout: post
title:  "Redis主从与集群"
date:   2021-06-23 16:58:02
categories: Redis
---

#### 主从复制

用户可通过slaveof命令或在配置文件中设置slaveof选项开启主从复制功能。实现**读写分离、数据容灾**等需求。

复制功能通过指令PSYNC实现，PSYNC具**完整重同步**和**部分重同步**有两种模式：

* 完整重同步**依赖RDB**文件完成，slave向master发送同步命令后，master执行bgsave，**生成RDB文件发送给slave**，期间的命令使用缓冲区记录，
最后将记录在**缓冲区内的命令发送给slave*，完成同步。
    
* 部分重同步的实现由三个部分构成：

    * master、slave的复制偏移量
        
        master与slave各自维护当前服务复制偏移量，M-S偏移量一致，表示主从当前数据一致。
        
    * master的复制积压缓冲区
        
       复制积压缓冲区是由master维护的一个固定长度、先进先出的队列。master进行命令传播时，将写命令发送给slave的同时，也会写入复制积压缓冲区中。
       缓冲区内的命令还记录有相应的复制偏移量，以供主从断连恢复时，进行部分重同步。
       
       缓冲区的大小可配置，可使用2 * second(估算主从断连恢复时间) * write_size_per_second(master每秒写入数据量)估算，合理配置缓冲区大小，
       尽可能的避免完整重同步。

    * 服务器的运行id
        
        实例标识，master区分slave实例。
        
主从模式中，当有key过期时：

* master在删除一个过期key后，会显示的向slave发送一个DEL命令。
* slave执行读命令，**即使key已过期，也会正常返回，不会主动删除key**，接到master发来的DEL命令后，再删除过期键。
        
#### 集群

Redis集群是Redis提供的分布式数据库方案，集群通过分片来进行数据共享，并提供复制和故障转移功能。高性能、高可用且易扩展。通过配置cluster-enable
为yes开启服务器的集群模式，每个节点的数据都必须存在0号数据库。使用CLUSTER MEET命令添加节点。

* 槽指派
    
    集群的整个数据库被分为16384个slot，集群中的每个节点可以处理0或最多16384个slot。**每个节点都记录有当前16384个slot的指派信息**。处理命令
时，通过**CRC16(KEY) & 16383计算当前key属于哪个槽**。当节点发现key所在的slot不由自己负责时，通过**MOVED错误将客户端转向负责此slot的节点**，
转向过程客户无感知。    

* 重新分片

    重新分片一般发生在**添加或移除节点**时，是指从源节点将任意数量的slot改为指派给目标节点的过程，相关slot内存储的K-V也会转移动到目标节点。操作为
online的，集群可以正常对外提供服务。
    
    slot迁移过程中，当有命令需要访问key落在槽内，如果源节点内存在，直接返回，如果不存在，通过ASK错误指引客户端转向目标节点，转向过程客户无感知。    

* 复制与故障转移

    主节点故障下线后，再从节点中选举新的从节点替代。选举基于[Raft算法](http://thesecretlivesofdata.com/raft/)实现，当前集群内的所有主节点都有投票权，
**第一个向主节点要求投票的从节点将获得主节点的投票。当一个从节点获取超过一半的投票时，当选为新的主节点**。




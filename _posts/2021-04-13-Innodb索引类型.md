---
title:  Innodb索引类型
date:   2021-04-13 19:53:23
categories: 
- MySQL
---

索引是**存储引擎实现**，用于快速找到记录的一种**数据结构**。不同存储引擎的索引工作方式不同，即使是不同引擎支持同一类型的索引，
其底层的实现也可能不同。

#### Innodb索引类型

* B+Tree 
* Hash索引
* 全文索引



#### B+Tree

M阶B+树的性质：

* 数据项存储在叶节点；

* 非叶子节点最多存储`M-1`个关键字，指示搜索方向；

* 根节点的儿子数在2-M之前，若根只有一个儿子，应删除该根并让他的儿子作为新根，降低树的高度；

* 除根外，非叶子节点的儿子数在 `M/2-M`之间；不满足时可通过领养、合并、分裂等操作校正；

* 叶子节点都在相同的深度，叶子节点数据用链表相连；


##### 磁盘IO与预读

磁盘IO是指从磁盘读取一次数据，需要磁臂转动，非常耗时，计算机操作系统做了一些优化，当一次IO时，不光把当前磁盘地址的数据，而且把相邻的数据也都读取到内存缓冲区内，
因为局部预读性原理告诉我们，当计算机访问一个地址的数据的时候，与其相邻的数据也会很快被访问到。每一次IO读取的数据我们称之为一页(page)。页的大小通常为磁盘块大小的 2^n 倍。

采用多阶树是为了查找数据时减少磁盘IO。M的大小与磁盘区块及索引字段的大小有关。每个磁盘块的数据项的数量m = 磁盘块的大小 / 数据项的大小，
当数据量N一定的情况下，m越大，则树越低，则需要的磁盘IO次数越少，查询效率越高。

##### 聚簇索引

聚簇索引是指一种**数据存储方式**，将索引与数据行放在同一个文件结构中，数据行存放在索引树的叶子节点中。Innodb中自动将主键作为聚簇索引，若表未设置主键，
则使用非空唯一键代替，若也不存在，Innodb会使用`DB_ROW_ID`作为隐藏自增主键，`DB_ROW_ID`是Innodb为每行数据默认添加的字段。

若表有主键，应尽量使用自增主键，避免因不规则主键插入导致为了维护索引有序性，造成的`页分裂`，影响服务性能及存储空间利用率，而且行比较稀疏，也会导致
全表扫描变慢。

##### 树高与数据行数

MySQL InnoDB页的大小默认是 16k（可通过参数innodb_page_size调整），B+树的索引共包含两部分内容：索引值及指向子节点的指针，当主键ID为bigint类型，长度为8字节，而指向子节点的指针大小在InnoDB源码中设置为6字节，
即单个索引一共14字节，则每页可存放的索引数为 16384/14=1170。

若单行数据的大小为1kb，即1个叶子节点只能存放16行数据，此时：
* 若树高为2，则可存放 1170 * 16=18720 条数据；
* 若树高为3，则可存放 1170 * 1170 * 16=21902400 条数据。

可见采用B+树作为索引数据结构的优越性。


##### 二级索引

与聚簇索引不同，二级索引的叶子节点中存放的是主键索引的值。在使用二级索引的过程中，因为二级索引没有存储全部的数据，假如二级索引满足查询需求，
则直接返回，即为**覆盖索引**，反之则需要**回表**去主键索引(聚簇索引)查询。

二级索引按照类型又可分为**普通索引**与**唯一索引**，不同点在于唯一索引要求被索引的列除null值外唯一，当需要数据库层面做唯一性校验时，可用唯一索引。

因为叶子节点中为主键索引的值，显然，若主键字段越小，普通索引的叶子节点就越小，二级索引占用的空间也就越小，所以要避免使用过长的字段作为主键。


##### 索引原则

* 最左前缀匹配原则，对于联合索引，mysql会一直向右匹配直到遇到范围查询(>、<、between、like(非前缀)就停止匹配；

* =和in可以乱序；

* 尽量选择区分度高的列作为索引，区分度的公式是count(distinct col)/count(*)，表示字段不重复的比例，比例越大我们扫描的记录数越少；

* 索引列不能参与计算；

* 尽量的扩展索引，不要新建索引，

##### 索引下推

对于联合索引，当到遇到范围查询(>、<、between、like)后，会停止匹配索引。MySQL5.6引入的索引下推优化`index condition pushdown`，
可以在索引遍历过程中，对索引中包含的字段先做判断，直接过滤掉不满足条件的记录，减少回表次数。


#### 自适应哈希索引

此功能是Innodb引擎一个完成自动的、内部的功能，用户无法控制或配置。如有必要可关闭。配置项为`innodb_adaptive_hash_index`。

* Innodb存储引擎会监控对表上各索引页的查询，如果观察到建立哈希索引可以带来速度提升，就会建立哈希索引，所以称为自适应哈希索引;

* 自适应哈希索引是通过缓冲池的B+树页来构造的，因此建立的速度很快，不需要对整张表构建哈希索引;

* Innodb会自动根据访问的频率和模式来自动的为某些热点页建立哈希索引;


#### 全文索引

全文索引，是一种通过建立倒排索引，快速匹配文档的方式(Elastic Search)。MySQL5.6版本开始支持Innodb引擎的全文索引，
支持在CHAR、VARCHAR、TEXT类型的列上定义全文索引。

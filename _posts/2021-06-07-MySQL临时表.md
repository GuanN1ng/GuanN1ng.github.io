---
layout: post
title:  "MySQL 临时表"
date:   2021-06-07 20:52:14
categories: MySQL
---

MySQL中的临时表可分为由系统创建的**内部临时表**和由用户通过`create temporary table...`创建的**用户临时表**。


####内部临时表

当一个SQL语句的执行计划中显示**Using temporary**，表示这个SQL的执行过程中需要使用临时表。

```
mysql> explain select * from t where b > '1000'  order by rand() limit 10;
+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------------------------------------------+
| id | select_type | table | partitions | type  | possible_keys | key  | key_len | ref  | rows  | filtered | Extra                                                     |
+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------------------------------------------+
|  1 | SIMPLE      | t     | NULL       | index | NULL          | a_b  | 10      | NULL | 99798 |    33.33 | Using where; Using index; Using temporary; Using filesort |
+----+-------------+-------+------------+-------+---------------+------+---------+------+-------+----------+-----------------------------------------------------------+
```

可能导致MySQL使用临时表的情况有：
*  group by 和 order by中的列不相同
*  order by的列不是引用from 表列表中 的第一表
*  group by的列不是引用from 表列表中 的第一表
*  含有distinct 的 order by语句


临时表可分为内存临时表和磁盘临时表，**tmp_table_size**限制了内存临时表的大小，若果临时表大小超过了tmp_table_size，内存临时表就会转为磁盘临时表，内存临时表基于
**memory引擎**，磁盘临时表的默认引擎是innodb。

采用**memory引擎**的内存表，**数据与索引分开存放**，数据已数组的形式存放在内存中，索引上保存数据的位置，数据按照写入顺序存放，删除的行位置可直接复用，支持**hash索引和
B+Tree索引**。memory引擎**只支持表锁，不支持行锁**。当数据库发生重启时，内存表会被清空。

```
mysql> show variables like 'tmp_table_size';
+----------------+----------+
| Variable_name  | Value    |
+----------------+----------+
| tmp_table_size | 16777216 | //默认16M
+----------------+----------+
```


####用户临时表

用户临时表通常被用来优化复杂查询，如**分库分表系统的跨库查询，通过将各个分库获取的数据汇总到一个临时表中，然后在临时表内做进一步的逻辑操作**。

临时表具有以下特点：
* 建表语法`create temporary table...`；
* 一个临时表只能被创建它的session访问，对其他线程不可见；
* 临时表可以与普通表重名；
* 当一个session内有同名的临时表及普通表时，show create及CRUD语句访问的是临时表；
* show tables命令不显示临时表；
* 临时表会在session结束时自动回收。

临时表能够实现与普通表，或session间重名基于两点，第一，临时表的表定义的物理磁盘文件及数据文件都会放在**临时文件目录**下，表定义的物理文件前缀命名格式
为**#sql{进程id}_{线程id}_序列号**。第二，在内存中，MySQL对每个表都维护了一个**table_def_key**，用以区分不同表，**普通表的key为"库名+表名"，
临时表的key为"server_id+thread_id+库名+表名"**。


主备复制时，如果binlog的格式为row时，那么和临时表有关的语句不会记录到binlog中，如果是statment/mixed时，为不影响备库执行逻辑，binlog中会记录
有关临时表的sql。




